<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Elements.Wasm</title>
    <base href="/" />
    <script defer src="https://unpkg.com/es-module-shims@0.4.6/dist/es-module-shims.js"></script>
    <script type="importmap-shim">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.137.5/build/three.module.js",
          "three/examples/jsm/": "https://unpkg.com/three@0.137.5/examples/jsm/"
        }
      }
      </script>
</head>

<body>
    <script type="module" src="elements.js"></script>
    <script src="https://elements.hypar.io/blazor.webassembly.js" autostart="false"></script>
    <script type="module-shim">
        function loadModel(glb) {
            const blob = new Blob([new Uint8Array(glb)], { type: "application/octet-stream" });
            const blobUrl = URL.createObjectURL(blob);

            const loader = new GLTFLoader();

            loader.load(
                blobUrl,
                function (gltf) {

                    if (gltfScene != null) {
                        scene.remove(gltfScene);
                    }

                    scene.add(gltf.scene);
                    gltfScene = gltf.scene;

                    URL.revokeObjectURL(blobUrl);

                    return true;
                },
                function (xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function (error) {
                    console.log('An error happened');
                    console.log(error)
                }
            );
        }

        function reset() {
            document.getElementById("result").innerHTML = "";
        };

        function runTest(value) {
            elements.test(value).then((result) => {
                document.getElementById("result").innerHTML = result.results
                model.loadModel(result.glb)
            });
        };

        function loadTestModel() {
            var request = new XMLHttpRequest();
            request.open("GET", "model.json", false);
            request.send(null)
            elements.modelToGlbBytes(request.responseText).then((result) => {
                model.loadModel(result)
            })
        }

        async function startBlazor() {
            await Blazor.start({
                loadBootResource: function (type, name, defaultUri, integrity) {
                    // console.log(`Loading: '${type}', '${name}', '${defaultUri}', '${integrity}'`);
                    const root = 'https://elements.hypar.io'
                    switch (type) {
                        case 'manifest':
                        case 'assembly':
                        case 'globalization':
                        case 'dotnetjs':
                        case 'dotnetwasm':
                        case 'timezonedata':
                            return `${root}/${name}`
                    }
                    return null
                },
            })
        }
        startBlazor()

        window.model = {
            reset: () => { reset(); },
            runTest: (value) => { runTest(value); },
            loadModel: (glb) => { loadModel(glb) },
            loadTestModel: () => { loadTestModel() }
        };

        import { Scene, PerspectiveCamera, WebGLRenderer, DirectionalLight, sRGBEncoding} from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';

        const scene = new Scene();
        let gltfScene = null;
        const camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        const renderer = new WebGLRenderer({ alpha: true } );
        renderer.physicallyCorrectLights = true;
        renderer.outputEncoding = sRGBEncoding;
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const directionalLight = new DirectionalLight( 0xffffff, 3.0 );
        scene.add( directionalLight );

        camera.position.z = 5;
        camera.position.y = 5;
        camera.position.x = 5;

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        };

        animate();
    </script>
    <input type="range" min="1" max="500" value="1" class="slider" id="myRange" oninput="model.reset()"
        onchange="console.debug(this.value);model.runTest(parseFloat(this.value))">
    <button type="button" id="loadButton" onclick="model.loadTestModel()">Load Test Model</button>
    <div id="result" style="white-space: pre-line; position: absolute; left: 20px; bottom: 20px"></div>
</body>

</html>